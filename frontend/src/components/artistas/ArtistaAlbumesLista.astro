---
import { INTERNAL_BACKEND_URL } from "../../config/backend";

interface Album {
    id: number;
    titulo: string;
    descripcion: string | null;
    portada?: string;
    portadaUrl?: string | null;
}

interface Props {
    artistaId: number;
}

const { artistaId } = Astro.props;

let albums: Album[] = [];

try {
    const res = await fetch(
        `${INTERNAL_BACKEND_URL}/api/public/artista/${artistaId}/album`,
    );

    if (res.ok) {
        const data = await res.json();
        albums = Array.isArray(data) ? (data as Album[]) : (data.content ?? []);
    } else {
        //console.error("[ArtistaAlbumesLista] error:", res.status);
    }
} catch (err) {
    //console.error("[ArtistaAlbumesLista] Error cargando albumes:", err);
}

// helper para elegir bien la portada
function getPortada(al: Album): string {
    // Si el backend devuelve "/uploads/portadas/xxx.png" en "portada" o "portadaUrl"
    const raw =
        al.portadaUrl && al.portadaUrl !== ""
            ? al.portadaUrl
            : al.portada && al.portada !== ""
              ? al.portada
              : null;

    if (!raw) {
        return "";
    }

    return raw;
}
---

{
    albums.length > 0 && (
        <section>
            <ul class="flex flex-col gap-2 divide-white/10">
                {albums.map((al) => (
                    <li class="flex items-center gap-4 py-3 px-2 rounded-xl hover:bg-white/5 transition">
                        <img
                            src={getPortada(al)}
                            alt={al.titulo}
                            class="w-12 h-12 rounded-lg object-cover border border-white/10"
                            loading="lazy"
                        />

                        <div class="flex-1 flex flex-col">
                            <p class="text-white font-medium">{al.titulo}</p>
                            {al.descripcion && (
                                <p class="text-xs text-gray-400 line-clamp-2">
                                    {al.descripcion}
                                </p>
                            )}
                        </div>
                    </li>
                ))}
            </ul>
        </section>
    )
}

{
    albums.length === 0 && (
        <p class="text-sm text-gray-400">No hay Ã¡lbumes disponibles.</p>
    )
}
